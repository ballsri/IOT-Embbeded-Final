<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no\" />
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="../home.css" />
  <script src="../inputHandler.js"></script>
  <script src="../function.js"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <title>CONTROL</title>
</head>

<body>
  <h1>Smart Watering Controller</h1>
  <div>
    <div id="clock" name="clock"></div>
  </div>
  <div class="body-container">
    <!-- Daily Env Part -->
    <div class="container-env">
      <iframe style="background: #FFFFFF;border: none;border-radius: 2px;box-shadow: 0 2px 10px 0 rgba(70, 76, 79, .2);" width="480" height="360" src="https://charts.mongodb.com/charts-embedded-sys-csjfj/embed/charts?id=62964bf0-cb9e-4ae3-8913-564855462547&maxDataAge=3600&theme=light&autoRefresh=true"></iframe>
      <iframe style="background: #FFFFFF;border: none;border-radius: 2px;box-shadow: 0 2px 10px 0 rgba(70, 76, 79, .2);" width="480" height="360" src="https://charts.mongodb.com/charts-embedded-sys-csjfj/embed/charts?id=6296540c-cb9e-4e12-8134-5648554f7599&maxDataAge=3600&theme=light&autoRefresh=true"></iframe>
    </div>
    <!-- controller part -->
    <div class="container-control">
      <input type="hidden"  id="time" value="<%= timeout %>" />
      <input type="hidden"  id="cooldown" value="<%= cooldownEnd %>" />
      <input type="hidden"  id="isOn" value="<% if(isActive){ %>on<% }else{%>off<%}%>" />
      <input type="hidden"  id="cooldownDate" value="<%= cooldownDate %>" />
      <p style="font-size: 24px" id="water-status">
        Water Status: <% if(isActive){ %> On <% }else{%> Off <%}%>
      </p>
      <% if (isActive && !isDisabled && !isCooldown) { %>
        <button class="button button-on" id="button-status" type="button" onclick="btnStatus()">
          <p>ON</p>
        </button>
        
        <% } else if(isDisabled && !isCooldown) { %>
          <button class="button button-off" id="button-status" onclick="btnStatus()" type="button" disabled>
            <p>DISABLE</p>
          </button>

          <% } else if(isCooldown){ %>
            <button class="button button-on" id="button-status" type="button" onclick="btnStatus()" disabled>
              <p>COOLING DOWN</p>
            </button>
            <% } else { %>
            <button class="button button-off" id="button-status" type="button" onclick="btnStatus()">
              <p>OFF</p>
            </button>
            <%} %>

              <p style="font-size: 24px">Amount of water to fill</p>

              <div class="form__group field" id="water-value">
                <% if(isActive|| isCooldown || isDisabled){ %>
                  <label for="Amount" class="form__fieldblock">
                    Wait for Watering ...
                  </label>

                  <%} else { %>
                    <div class="form__box field" id="water-value">
                      <input type="number" class="form__field" placeholder="Amount" name="Amount" id="water-amount"
                        required min="4.44" max="1114.44" step="4.44" onchange="waterAmountChangeHandler()" />
                      <label for="water-amount" class="form__label">Amount (mL)</label>
                    </div>
                    <button class="button button-log" id="submit-water" onclick="sendWater()">
                      Submit
                    </button>

                    <%} %>
              </div>
              <div id = "cdTime" class = "hidden">Cooldown
                <div id = "cooldownTime"></div>
              </div>
    </div>

    <!-- info part -->
    <div class="container-info">
      <h2>Information</h2>
      <div class="pill">
        <h6>Light</h6>
        <p id="light">
          <%= latest[0].light %>
        </p>
      </div>
      <div class="pill">
        <h6>Soil Humidity</h6>
        <p id="humid">
          <%= latest[0].humid %>
        </p>
      </div>
      <div class="pill">
        <h6>Prev Watering</h6>
        <p id="water">
          <%= latest[0].water %>
        </p>
      </div>
      <p>updated: <%= (new Date(latest[0].time)).toLocaleString() %>
      </p>
      <p style="font-size: 24px">get Information</p>
      <!-- <a class="button button-getinformation" href="/getinformation"
          >SubmitXnoNeed</a
        > -->
      <a class="button button-log" style="margin: 0px auto 35px" href="/log?id=0">log</a>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"
    integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script>
    <script>
      setInterval(() => {
        var realtime = new Date();
        var hour = realtime.getHours();
        var minute = realtime.getMinutes();
        var second = realtime.getSeconds();
        var ampm = (hour < 12) ? "AM" : "PM";
        var cdtime = new Date(document.getElementById("cooldownDate").value);
        var timeDif = cdtime.getTime() - realtime.getTime();
        if(timeDif < 0) timeDif = 0;
        timeDif = Math.floor(timeDif/1000);
        var hourleft = Math.floor(timeDif/3600);
        timeDif = timeDif%3600;
        var minuteleft = Math.floor(timeDif/60);
        timeDif = timeDif % 60;
        var secondleft = timeDif;
        if((hourleft > 0 || minuteleft > 0 || secondleft > 0)){
          document.getElementById("cdTime").classList.remove("hidden");
        }
        else{
          document.getElementById("cdTime").classList.add("hidden");
        }
        hourleft = ("0" + hourleft).slice(-2);
        minuteleft = ("0" + minuteleft).slice(-2);
        secondleft  = ("0" + secondleft).slice(-2);
        hour = hour%12;
        hour = ("0" + hour).slice(-2);
        minute = ("0" + minute).slice(-2);
        second  = ("0" + second).slice(-2);
        document.getElementById("clock").innerHTML = hour + " : " + minute + " : " + second + " " + ampm;
        document.getElementById("cooldownTime").innerHTML = hourleft + " : " + minuteleft + " : " + secondleft;
        // var t = setTimeout(realtimeClock,500);
      }, 1000);
      
    </script>
</body>

</html>